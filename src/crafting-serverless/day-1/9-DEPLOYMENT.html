
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>09. Deployment preferences Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc/page-toc.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-accordion/accordion.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../day-2/" />
    
    
    <link rel="prev" href="8-CICD.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../WARMUPS.html">
            
                <a href="../WARMUPS.html">
            
                    
                    Warmups
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Day 1
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="1-SETUP.html">
            
                <a href="1-SETUP.html">
            
                    
                    01. Setup your AWS Account
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="2-LAMBDA.html">
            
                <a href="2-LAMBDA.html">
            
                    
                    02. Serverless app with AWS Lambda
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="3-CLOUDFORMATION.html">
            
                <a href="3-CLOUDFORMATION.html">
            
                    
                    03. CloudFormation Infra as Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="4-APIGW.html">
            
                <a href="4-APIGW.html">
            
                    
                    04. APIs withs API Gateway
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="5-DEBUG.html">
            
                <a href="5-DEBUG.html">
            
                    
                    05. Debugging serverless apps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="6-DYNAMODB.html">
            
                <a href="6-DYNAMODB.html">
            
                    
                    06. DynamoDB a serverless database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="7-TESTING.html">
            
                <a href="7-TESTING.html">
            
                    
                    07. Designing Testable Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="8-CICD.html">
            
                <a href="8-CICD.html">
            
                    
                    08. CI/CD
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.9" data-path="9-DEPLOYMENT.html">
            
                <a href="9-DEPLOYMENT.html">
            
                    
                    09. Deployment preferences
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../day-2/">
            
                <a href="../day-2/">
            
                    
                    Day 2
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../day-2/01-UPLOAD-RECEIPTS.html">
            
                <a href="../day-2/01-UPLOAD-RECEIPTS.html">
            
                    
                    01. Upload receipts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../day-2/02-EXTRACT-RECEIPT-TEXT.html">
            
                <a href="../day-2/02-EXTRACT-RECEIPT-TEXT.html">
            
                    
                    02. Extract receipt text
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../day-2/03-BACKGROUND-PROCESSING.html">
            
                <a href="../day-2/03-BACKGROUND-PROCESSING.html">
            
                    
                    03. Performance optimization - background processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../day-2/04-COLD-START.html">
            
                <a href="../day-2/04-COLD-START.html">
            
                    
                    04. Performance optimization - latency and cold starts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../day-2/05-NO-LAMBDA.html">
            
                <a href="../day-2/05-NO-LAMBDA.html">
            
                    
                    05. Performance optimization - skip Lambdas
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../day-2/06-STREAMING.html">
            
                <a href="../day-2/06-STREAMING.html">
            
                    
                    06. Serverless streaming patterns
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../day-2/07-ORCHESTRATION.html">
            
                <a href="../day-2/07-ORCHESTRATION.html">
            
                    
                    07. Orchestration using Step functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../day-2/08-MIGRATION.html">
            
                <a href="../day-2/08-MIGRATION.html">
            
                    
                    08. The Enterprise Migration Path to Serverless
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../day-2/09-WARDLEY-MAPS.html">
            
                <a href="../day-2/09-WARDLEY-MAPS.html">
            
                    
                    09. Build or outsource - Designing a Serverless Architecture with Wardley Maps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../day-2/10-SERVERLESS-FOR-CFOS.html">
            
                <a href="../day-2/10-SERVERLESS-FOR-CFOS.html">
            
                    
                    10. Business case for refactoring
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../CONCLUSION.html">
            
                <a href="../CONCLUSION.html">
            
                    
                    Conclusion
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >09. Deployment preferences</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="serverless-deployment-preferences">Serverless Deployment Preferences</h1>
<p>The core principle of serverless work is that the platform is responsible for receiving events, not your code. The network socket (server) belongs to the hosting provider, not to your function. But also your Lambda versions. Each CloudFormation deployment, creates a new version. When we deployed the expenses stack, SAM wired the API gateway to our Lambda function to always use the $LATEST version. That&#x2019;s OK for a simple case, but it might be problematic for backwards incompatible deployments in the future. Updating a distributed architecture is not instantaneous. We don&#x2019;t want the API somehow to get updated first, then send a new version of an event to an older version of the function that does not know how to handle it.</p>
<p>You can define what it means for a deployment to be problematic. For example, split the users into a control group working with the existing code and a test group that sees the new version, then automatically check for Lambda errors or time-outs. That way you can quickly prevent integration problems that were not detected during testing. Alternatively, run the experiment over a longer period of time and measure user behaviour, such as funnel conversion or purchases. For example, if the unit and integration tests passed, but something unexpected is causing users to buy less with the new version, would it not be smart to automatically roll back and protect revenue, and alert someone to investigate it?</p>
<p>And now guess what the &quot;Sauf Pompiers&quot; SARL folks want you to do, and enable?</p>
<p>SAM has a convenient shortcut for publishing configuration versions, and for ensuring that event sources (such as API Gateway) are correctly configured to request that particular version. All you need to do is add <code>AutoPublishAlias</code> to the function properties in template.yaml. When SAM publishes a configuration version, it will automatically create or update the specified alias to point to that version.</p>
<blockquote>
<p><strong>Important.</strong> Lambda and API Gateway charge for requests, not for the number of environments, so there is no special cost to keep an old copy around while the new one is being created.</p>
</blockquote>
<p>AWS CodeDeploy, another <code>Code-</code> product can modify the routing configuration over time to gradually switch between several versions of code and infrastructure. CodeDeploy can, for example, show the new version of an application to only 10% of the users and wait for a short period while monitoring for unexpected problems. If everything looks OK, CodeDeploy can expose the new version to everyone, and shut down the old version. On the other hand, if the new version seems to be problematic, CodeDeploy will just roll back the experimental version and move all the users back to the old infrastructure. Reassigning aliases to published configuration versions is very quick, much faster than a redeployment.</p>
<blockquote>
<p><strong>Interesting fact.</strong> By default, an AWS account has 75 GB available for storing Lambda functions, including the code for all published versions. SAM will not automatically clean up old versions for you, so you may need to periodically do some housekeeping if you deploy large packages frequently.</p>
</blockquote>
<p>AWS SAM enables us to utilize the CodeDeploy on a per-function level using a <code>Properties</code> field called <code>DeploymentPreference</code>.</p>
<h2 id="tasks">Tasks</h2>
<ol>
<li><p>Add it to all 3 of your functions and make it a Linear 10% deployment every minute. You can read about that <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/automating-updates-to-serverless-apps.html" target="_blank">here</a> and <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-function-deploymentpreference.html" target="_blank">here is a more Documentation First approach</a>.</p>
</li>
<li><p>Change the codebase by commenting out the code for each function and just return a &quot;hello world&quot; text. Don&apos;t forget to add the appropriate API GW response format.</p>
</li>
<li><p>Deploy it and try every minute, using Postman or some other tool. You should see a percentage change in the responses you receive from your API each minute.</p>
</li>
<li><p>Revert or try other options.</p>
</li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="8-CICD.html" class="navigation navigation-prev " aria-label="Previous page: 08. CI/CD">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../day-2/" class="navigation navigation-next " aria-label="Next page: Day 2">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"09. Deployment preferences","level":"1.3.9","depth":2,"next":{"title":"Day 2","level":"1.4","depth":1,"path":"day-2/README.md","ref":"day-2/README.md","articles":[{"title":"01. Upload receipts","level":"1.4.1","depth":2,"path":"day-2/01-UPLOAD-RECEIPTS.md","ref":"day-2/01-UPLOAD-RECEIPTS.md","articles":[]},{"title":"02. Extract receipt text","level":"1.4.2","depth":2,"path":"day-2/02-EXTRACT-RECEIPT-TEXT.md","ref":"day-2/02-EXTRACT-RECEIPT-TEXT.md","articles":[]},{"title":"03. Performance optimization - background processing","level":"1.4.3","depth":2,"path":"day-2/03-BACKGROUND-PROCESSING.md","ref":"day-2/03-BACKGROUND-PROCESSING.md","articles":[]},{"title":"04. Performance optimization - latency and cold starts","level":"1.4.4","depth":2,"path":"day-2/04-COLD-START.md","ref":"day-2/04-COLD-START.md","articles":[]},{"title":"05. Performance optimization - skip Lambdas","level":"1.4.5","depth":2,"path":"day-2/05-NO-LAMBDA.md","ref":"day-2/05-NO-LAMBDA.md","articles":[]},{"title":"06. Serverless streaming patterns","level":"1.4.6","depth":2,"path":"day-2/06-STREAMING.md","ref":"day-2/06-STREAMING.md","articles":[]},{"title":"07. Orchestration using Step functions","level":"1.4.7","depth":2,"path":"day-2/07-ORCHESTRATION.md","ref":"day-2/07-ORCHESTRATION.md","articles":[]},{"title":"08. The Enterprise Migration Path to Serverless","level":"1.4.8","depth":2,"path":"day-2/08-MIGRATION.md","ref":"day-2/08-MIGRATION.md","articles":[]},{"title":"09. Build or outsource - Designing a Serverless Architecture with Wardley Maps","level":"1.4.9","depth":2,"path":"day-2/09-WARDLEY-MAPS.md","ref":"day-2/09-WARDLEY-MAPS.md","articles":[]},{"title":"10. Business case for refactoring","level":"1.4.10","depth":2,"path":"day-2/10-SERVERLESS-FOR-CFOS.md","ref":"day-2/10-SERVERLESS-FOR-CFOS.md","articles":[]}]},"previous":{"title":"08. CI/CD","level":"1.3.8","depth":2,"path":"day-1/8-CICD.md","ref":"day-1/8-CICD.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["page-toc","accordion"],"pluginsConfig":{"page-toc":{"position":"before-first","selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4","showByDefault":true},"accordion":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"day-1/9-DEPLOYMENT.md","mtime":"2020-02-26T17:54:19.558Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-02-26T23:29:55.575Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-page-toc/anchor-3.1.1.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-page-toc/page-toc.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-accordion/accordionSelector.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

