
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>07. Designing Testable Functions Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc/page-toc.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-accordion/accordion.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="8-CICD.html" />
    
    
    <link rel="prev" href="6-DYNAMODB.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../WARMUPS.html">
            
                <a href="../WARMUPS.html">
            
                    
                    Warmups
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Day 1
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="1-SETUP.html">
            
                <a href="1-SETUP.html">
            
                    
                    01. Setup your AWS Account
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="2-LAMBDA.html">
            
                <a href="2-LAMBDA.html">
            
                    
                    02. Serverless app with AWS Lambda
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="3-CLOUDFORMATION.html">
            
                <a href="3-CLOUDFORMATION.html">
            
                    
                    03. CloudFormation Infra as Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="4-APIGW.html">
            
                <a href="4-APIGW.html">
            
                    
                    04. APIs withs API Gateway
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="5-DEBUG.html">
            
                <a href="5-DEBUG.html">
            
                    
                    05. Debugging serverless apps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="6-DYNAMODB.html">
            
                <a href="6-DYNAMODB.html">
            
                    
                    06. DynamoDB a serverless database
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.7" data-path="7-TESTING.html">
            
                <a href="7-TESTING.html">
            
                    
                    07. Designing Testable Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="8-CICD.html">
            
                <a href="8-CICD.html">
            
                    
                    08. CI/CD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="9-DEPLOYMENT.html">
            
                <a href="9-DEPLOYMENT.html">
            
                    
                    09. Deployment preferences
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../day-2/">
            
                <a href="../day-2/">
            
                    
                    Day 2
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../day-2/01-UPLOAD-RECEIPTS.html">
            
                <a href="../day-2/01-UPLOAD-RECEIPTS.html">
            
                    
                    01. Upload receipts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../day-2/02-EXTRACT-RECEIPT-TEXT.html">
            
                <a href="../day-2/02-EXTRACT-RECEIPT-TEXT.html">
            
                    
                    02. Extract receipt text
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../day-2/03-BACKGROUND-PROCESSING.html">
            
                <a href="../day-2/03-BACKGROUND-PROCESSING.html">
            
                    
                    03. Performance optimization - background processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../day-2/04-COLD-START.html">
            
                <a href="../day-2/04-COLD-START.html">
            
                    
                    04. Performance optimization - latency and cold starts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../day-2/05-NO-LAMBDA.html">
            
                <a href="../day-2/05-NO-LAMBDA.html">
            
                    
                    05. Performance optimization - skip Lambdas
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../day-2/06-STREAMING.html">
            
                <a href="../day-2/06-STREAMING.html">
            
                    
                    06. Serverless streaming patterns
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../day-2/07-ORCHESTRATION.html">
            
                <a href="../day-2/07-ORCHESTRATION.html">
            
                    
                    07. Orchestration using Step functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../day-2/08-MIGRATION.html">
            
                <a href="../day-2/08-MIGRATION.html">
            
                    
                    08. The Enterprise Migration Path to Serverless
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../day-2/09-WARDLEY-MAPS.html">
            
                <a href="../day-2/09-WARDLEY-MAPS.html">
            
                    
                    09. Build or outsource - Designing a Serverless Architecture with Wardley Maps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../day-2/10-SERVERLESS-FOR-CFOS.html">
            
                <a href="../day-2/10-SERVERLESS-FOR-CFOS.html">
            
                    
                    10. Business case for refactoring
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../CONCLUSION.html">
            
                <a href="../CONCLUSION.html">
            
                    
                    Conclusion
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >07. Designing Testable Functions</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="designing-testable-serverless-functions">Designing Testable Serverless Functions</h1>
<p>Writing all that serverless code is great, but as you could see debugging serverless apps wasn&apos;t very fun, so its much better to test beforehand. We need to ensure and be confident in the current implementation and ensure that any future modifications don&apos;t break it.</p>
<p>How do we test traditional applications?
In the following diagram you can see the traditional testing pyramid:</p>
<p><img src="images/testing-pyramid.png" alt="Testing Pyramid"></p>
<p>As you can notice the biggest cost here are the manual tests. The ones we do the most are unit tests, then integration and the least used and the most costly are the automated UI tess.</p>
<p>Does serverless change how do we tests?</p>
<p>The major difference lies in the infrastructure and its cost.</p>
<p><img src="images/serverless-testing-pyramid.png" alt="Testing Pyramid"></p>
<p>The most important thing to notice here is that the cost of all tests has reduced dramatically for both integration and automated UI tests. The reason for that lies in the reduced spend for infrastructure. You no longer need to pay in advance for new infrastructure, those are available out of the box.</p>
<h2 id="writing-your-first-serverless-tests">Writing your first serverless tests</h2>
<p>In general, the codebase you will see both online and in production will reflect the past traditional practices of writing tests.</p>
<p>Let&apos;s take a look at our simple <code>enter-expense</code> Lambda function that kind of works, but unfortunately gets the whole design wrong. It listens to API events, and when a request comes, it picks up the expense data and saves its data to a DynamoDB table.</p>
<pre><code class="lang-javascript">exports.handler = <span class="hljs-keyword">async</span> event =&gt; {
  <span class="hljs-keyword">const</span> item = <span class="hljs-built_in">JSON</span>.parse(event.body);
  item.expenseId = uuidv4();
  <span class="hljs-keyword">const</span> params = {
    TableName: TABLE_NAME,
    Item: item
  }
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> dynamoDb.put(params).promise()
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> {
      statusCode: <span class="hljs-number">500</span>,
      body: <span class="hljs-built_in">JSON</span>.stringify(error)
    }
  }
};
</code></pre>
<p>The problem with this function is that it&#x2019;s almost impossible to test well in an automated way. Sure, we can load it even without running in Lambda, but we&#x2019;d still have to connect to a real API GW service. We could run tests with simulated events that look similar to API events, but that will still be very slow and brittle. It will be difficult to test error scenarios. Things like that are difficult to automate and simulate. Because this function is difficult to test properly, many important edge cases just won&#x2019;t be covered.</p>
<p>To be able to inspect each of those separately, we first need to break down the code into several functions. One good guide for that is the Hexagonal architecture pattern, also called Ports-and-Adapters.</p>
<p>The Hexagonal Architecture is a design pattern where the core of an application does not directly talk with external resources or allow any external collaborators to talk to it directly. Instead, it talks to a layer of boundary interfaces, using protocols designed specifically for that application. External collaborators then connect to those interfaces,and translate from the concepts and protocols important for resource to the ones important for the application. For example, the core of the application in a Hexagonal Architecture wouldn&#x2019;t directly receive Lambda events, it would receive something in an application-specific format, say with <code>amount</code>, <code>currency</code>, <code>expenseData</code> and <code>issuer</code> describing the expense received. An adapter would be responsible for converting between the Lambda event format and the application event format. You could call it an <code>expense-parser</code>.</p>
<p>Similarly, our <code>enter-expense</code> Lambda function would not talk to DynamoDB directly, but it would talk to a boundary interface that is specific for its needs. For example, we require a DynamoDB Document Client which has a function: <code>putItem</code>. In the Hexagonal Architecture we would then write a <code>StorageRepository</code> this implements that particular interface, and talks to DynamoDB to store an expense.</p>
<p>This separation would allow us to test DynamoDB integration without worrying about internal workflows. It would also allow us to test internal error handling easier, by providing a different database interface that we could control easily, and trigger errors.</p>
<p>Let&#x2019;s start to break this monolithic serverless function apart, and lets do this guided separation as the part of this section&apos;s task.</p>
<h2 id="task">Task</h2>
<ol>
<li><p>Create an <code>expense-parser</code> Port that would handle the incoming API request parameters and return an expense object that contains:</p>
<ul>
<li>issuer,</li>
<li>expenseDate,</li>
<li>description,</li>
<li>amount,</li>
<li>currency,</li>
<li>location</li>
</ul>
</li>
<li><p>Create a <code>storage-repository</code> Adapter which will implement the DynamoDB interface.</p>
</li>
<li><p>Refactor your <code>enter-expense</code> Lambda function core to utilize these ports and adapters.</p>
</li>
</ol>
<h2 id="hints">Hints</h2>
<p>Here are a few hints to help you with this task:</p>
<ol>
<li><p>The <code>expense-parser</code> is basically a class / transformer that takes in a regular API GW POST HTTP request and should return the Expense attributes. In case of an error it should throw an error. Remember that the same parser will be used for both list, update and enter expenses Lambda functions.</p>
</li>
<li><p>You can make the <code>storage-repository</code> a class with the following methods:</p>
<ul>
<li><code>save</code>, it should receive the <code>issuer</code>, <code>expenseDate</code>, <code>description</code>, <code>amount</code>, <code>currency</code>, <code>location</code>, and should not return anything. In case of an error it should throw it.</li>
<li><code>list</code>, takes in no parameters.</li>
<li><code>update</code>, should behave similarly as the <code>save</code>, but with one interesting exception, it needs an API <em>what if the expense</em> doesn&apos;t exist?
All three methods should call corresponding DynamoDB Document Client methods. Don&apos;t forget that!</li>
</ul>
</li>
</ol>
<p>Take time to discusss with your group on how would you share both the <code>storage-repository</code> and the <code>expense-parser</code> with the remaining two Lambda functions. Feel to Google it as well :)</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="6-DYNAMODB.html" class="navigation navigation-prev " aria-label="Previous page: 06. DynamoDB a serverless database">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="8-CICD.html" class="navigation navigation-next " aria-label="Next page: 08. CI/CD">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"07. Designing Testable Functions","level":"1.3.7","depth":2,"next":{"title":"08. CI/CD","level":"1.3.8","depth":2,"path":"day-1/8-CICD.md","ref":"day-1/8-CICD.md","articles":[]},"previous":{"title":"06. DynamoDB a serverless database","level":"1.3.6","depth":2,"path":"day-1/6-DYNAMODB.md","ref":"day-1/6-DYNAMODB.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["page-toc","accordion"],"pluginsConfig":{"page-toc":{"selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4","position":"before-first","showByDefault":true},"accordion":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"day-1/7-TESTING.md","mtime":"2020-02-25T16:17:16.180Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-02-28T08:17:42.016Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-page-toc/anchor-3.1.1.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-page-toc/page-toc.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-accordion/accordionSelector.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

